---
title: "p8105_hw3_lz3014"
auther: "Liqi Zhou"
date: 2024-10-14
output: github_document
---

```{r}
library(tidyverse)
```


# Problem 1
```{r}
library(p8105.datasets)
data("ny_noaa")
```

### 1.Write a short description of the dataset.
This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns, including seven variables: `id` (weather station id), `date` (date of observation), `prcp` (total daily precipitation), `snow` (snowfall), `snwd` (snow depth), `tmax` and `tmin` (min and max temperature).

### 2.Do some data cleaning. 
```{r}
ny_noaa_clean <- ny_noaa |>
  separate(date, into = c("year", "month", "day"), convert = TRUE) |>
  mutate(tmax = as.numeric(tmax), tmin = as.numeric(tmin))
```

- For snowfall, what are the most commonly observed values? Why?
0 is the most commonly observed value for snowfall, because most days of the year, it does not snow in NY.
```{r}
ny_noaa_clean |>
  count(snow) |>
  arrange(desc(n))
```

### 3.Make a two-panel plot showing the average max temperature in January and in July in each station across years.
```{r}
ny_noaa_clean |>
  filter(month %in% c(1, 7)) |>
  group_by(id, year, month) |>
  summarise(mean_tmax = mean(tmax, na.rm = TRUE)) |>
  ggplot(aes(x = year, y = mean_tmax, color = as.factor(month))) +
  geom_point() +
  geom_line() +
  facet_wrap(~ month, scales = "free_y") +
  labs(
    title = "Average Max Temperature in January and July across Stations",
    x = "Year",
    y = "Average Max Temperature (°C)",
    color = "Month"
  )
```

- Is there any observable / interpretable structure? Any outliers?
the mean temperature in January is significantly lower than in July across all stations and years. Stations generally show similar temperature trends over time—when one station records a higher temperature for a given year, others tend to follow the same pattern. However, we observe an unusually cold station in July of 1987 or 1988, along with a few other minor outliers.

### 4.Make a two-panel plot
- (i) tmax vs tmin for the full dataset (note that a scatterplot may not be the best option)
```{r}
ny_noaa_clean |>
  ggplot(aes(x = tmin, y = tmax)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", color = "lightblue", se = FALSE) + 
  labs(
    title = "Tmax vs Tmin",
    x = "Minimum Temperature (°C)",
    y = "Maximum Temperature (°C)"
  )
```

- (ii) make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.
```{r}
ny_noaa_clean |>
  filter(snow > 0, snow < 100) |>
  ggplot(aes(x = snow)) +
  geom_histogram(binwidth = 5, fill = "lightblue", color = "lightyellow") +
  facet_wrap(~ year) +
  labs(
    title = "Distribution of Snowfall by Year",
    x = "Snowfall",
    y = "Count"
  )
```


# Problem 2
### 1.Load, tidy, merge, and otherwise organize the data sets.
```{r}
covar <- read_csv(file = "./data/nhanes_covar.csv", skip = 4, na = c("NA",".","")) |>
  janitor::clean_names() |>
  filter(age >= 21) |>
  drop_na()

accel <- read_csv(file = "./data/nhanes_accel.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  drop_na()
```

- merge and tidy
```{r}
mims <- covar |>
  left_join(accel, by = "seqn")

mims_tidy <- 
  pivot_longer(
    mims,
    min1:min1440,
    names_to = "mins",
    names_prefix = "min",
    values_to = "accel_min_data"
  ) |>
  mutate(mins = as.numeric(mins))
```

- encode data with reasonable variable classes
```{r}
mims_tidy <- mims_tidy |>
  mutate(sex = factor(sex, levels = c(1, 2), 
                      labels = c("Male", "Female")), 
         education = factor(education, levels = c(1, 2, 3), 
                            labels = c("Less than high school", "High school equivalent", "More than high school")))
mims_tidy
```

### 2.Produce a reader-friendly table for the number of men and women in each education category 
```{r}
sex_tb <- mims_tidy |>
  group_by(education, sex) |>
  summarise(n_obs = n()) |>
  knitr::kable()
sex_tb
```

- create a visualization of the age distributions for men and women in each education category.
```{r}
mims_tidy |>
  ggplot(aes(x = age, fill = sex, color = sex)) + 
  geom_density(alpha = 0.5) +  
  facet_grid(. ~ education) +  
  labs(
    title = "Age Distribution by Gender and Education Level",
    x = "Age",
    y = "Density"
  ) +
  theme_minimal()
```

**comment:**  
- The `table` shows that the *"Less than high school"* level has the largest number of participants, and the distribution between men and women is relatively balanced in *"Less than high school"* and *"More than high school"*education levels. However, in the "High school equivalent" group, the number of men is much higher than the number of women.  
- The density `plot` shows that older individuals are more concentrated in the "Less than high school" group, while younger and middle-aged individuals are more evenly distributed in the "More than high school" group. There are also some gender differences in age distribution, particularly in the "More than high school" category.

### 3.Traditional analyses of accelerometer data 
- create a total activity variable for each participant. 
```{r}
mims_tidy <- mims_tidy |>
  group_by(seqn, sex, age, education) |>
  mutate(total_activity = sum(accel_min_data, na.rm = TRUE)) |>
  ungroup()
```

- Plot these total activities (y-axis) against age (x-axis). Include a trend line or a smooth to illustrate differences. 
```{r}
# calculate total activity for each person
mims_total_activity <- mims_tidy |>
  group_by(seqn, sex, age, education) |>
  summarise(total_activity = sum(accel_min_data, na.rm = TRUE)) |>
  ungroup()

mims_total_activity |>
  ggplot(aes(x = age, y = total_activity, color = sex)) + 
  geom_point(alpha = 0.5) +  
  geom_smooth(method = "loess", se = FALSE) +  
  facet_wrap(~ education) + 
  labs(
    title = "Total Activity by Age, Sex and Education Level",
    x = "Age",
    y = "Total Activity",
    color = "Sex"
  ) +
  theme_minimal()
```

**Comment:**  
- The plot shows that total activity generally decreases with age, especially for those with *"Less than a high school"* education level. In the *"High school equivalent"*, women's activity show more pronounced fluctuations. In the *"More than high school"* group, both sexes show similar trends.In the latter two groups, women are more numerous and maintain slightly higher activity while in *"Less than a high school"* men are more numerous than women across most age.

### 4.Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. 
```{r}
# calculate 24-hour activity data for each education level and sex
mims_hourly_activity <- mims_tidy |>
  select(seqn, sex, age, education, mins, accel_min_data) |>
  mutate(hour = floor((mins - 1) / 60) + 1) |>
  group_by(seqn, sex, age, education, hour) |>
  summarise(hour_activity = sum(accel_min_data, na.rm = TRUE)) |>
  ungroup()

edu_hourly_activity <- mims_hourly_activity |>
  group_by(education, hour, sex) |>
  summarise(edu_total_activity = sum(hour_activity, na.rm = TRUE)) |>
  ungroup()
```

```{r}
edu_hourly_activity |>
  ggplot(aes(x = hour, y = edu_total_activity, color = sex)) +  
  geom_point(alpha = 0.6) + 
  geom_smooth(method = "loess", se = FALSE) +  
  facet_wrap(~ education) + 
  labs(
    title = "24-Hour Activity Time Course by Education Level and Sex",
    x = "Time of Day",
    y = "Activity",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

**Describe this graph:**  
- The graph shows clear activity peaks around 11 AM to 5 PM across all education levels.  
- The *"More than high school"* education level has the highest activity values, with women being much more active than men.  
- In the *"High school equivalent"* group, men show higher activity than women.  
- In the *"Less than high school"* level, the activities of men and women are similar throughout 24 hours.


# Problem 3
### 1.Import, clean, merge and tidy these data
```{r}
jan_2020 <- read_csv(file = "./data/Jan 2020 Citi.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  drop_na() |>
  mutate(year = "2020", month = "january")

july_2020 <- read_csv(file = "./data/July 2020 Citi.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  drop_na() |>
  mutate(year = "2020", month = "july")

jan_2024 <- read_csv(file = "./data/Jan 2024 Citi.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  drop_na() |>
  mutate(year = "2024", month = "january")

july_2024 <- read_csv(file = "./data/July 2024 Citi.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  drop_na() |>
  mutate(year = "2024", month = "july")

citibike_NYC <- bind_rows(jan_2020, july_2020, jan_2024, july_2024) |>
  mutate(weekdays = factor(weekdays, 
                           levels = c("Monday", "Tuesday", "Wednesday", 
                                      "Thursday", "Friday", "Saturday", 
                                      "Sunday"), 
                           ordered = TRUE))
citibike_NYC
```

**Describe the resulting dataset:**  
- After cleaning and tidying, dataset `jan_2020` has `r nrow(jan_2020)` rows and `r ncol(jan_2020)` columns, dataset `july_2020` has `r nrow(july_2020)` rows and `r ncol(july_2020)` columns, dataset `jan_2024` has `r nrow(jan_2024)` rows and `r ncol(jan_2024)` columns, dataset `july_2024` has `r nrow(july_2024)` rows and `r ncol(july_2024)` columns.  
- Finally, we combine these four datasets into `citibike_NYC` which has `r nrow(citibike_NYC)` rows and `r ncol(citibike_NYC)` columns. It has information on Citi Bike rides in New York City in January 2020, July 2020, January 2024 and July 2024, including variables named *ride_id*, *rideable_type*, *weekdays*, *duration* and so on. 

### 2.Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members.
```{r}
rides_num_total <- citibike_NYC |>
  group_by(year, month, member_casual) |>
  summarise(total_rides = n()) |>
  arrange(year, month) |>
  select(year, month, member_casual, total_rides) |>
  knitr::kable()
rides_num_total
```

**Comment:**  
-There is a clear seasonal trend, with higher ride counts in July compared to January across both 2020 and 2024. This suggests that warmer months have more bike usage.   
- Additionally, member riders consistently outnumber casual riders in every period, indicating that the Citi Bike system is more frequently used by regular, subscribed users.

### 3.Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.
```{r}
popular_stations_july_2024 <- citibike_NYC |>
  filter(year == "2024", month == "july") |>
  count(start_station_name, sort = TRUE) |>
  top_n(5) |>
  rename(number_of_rides = n) |>
  knitr::kable()
popular_stations_july_2024
```

### 4.Make a plot to investigate the effects of day of the week, month, and year on median ride duration.
```{r}
ride_median_duration <- citibike_NYC |>
  group_by(year, month, weekdays) |>
  summarise(median_duration = median(duration, na.rm = TRUE)) |>
  ungroup()

ride_median_duration |>
  ggplot(aes(x = weekdays, y = median_duration, color = as.factor(month))) +
  geom_point() +  
  facet_grid(. ~ year) +
  labs(
    title = "Effect of Day of Week, Month, and Year on Median Ride Duration",
    x = "Day of the Week",
    y = "Median Ride Duration (minutes)",
    color = "Year"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

**Comment:**  
- From the plot, `[year]`in 2024, the ride durations appear slightly lower compared to 2020, especially in July, which might indicate improved riding efficiency or other external factors such as better infrastructure. `[month]`It can be observed that ride durations tend to be longer in January than in July for both 2020 and 2024. `[week]`Saturday tends to have higher median ride durations compared to other days of the week. We can konw from the plot that seasonal and weekly effects are significant factors influencing ride duration.

### 5.For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. 
```{r}
citibike_NYC |> 
  filter(year == 2024) |>
  ggplot(aes(x = duration, fill = member_casual)) +
  geom_density(alpha = 0.5) +
  facet_grid(rideable_type ~ month) +
  labs(title = "Impact of Month, Membership Status, and Bike Type on Ride Duration (2024)", 
       x = "Ride Duration (minutes)", 
       y = "Density", 
       fill = "Membership") +
  theme_minimal()
```

**Comment:**  
- Ride duration: Ride durations are generally short, with most rides under 50 minutes.  
- Membership status: Members tend to have slightly shorter ride durations compared to casual riders, since the peaks in the member curves is closer to zero durition line.  
- Bike type: Electric bikes show slightly shorter ride durations compared to classic bikes, especially among casual riders.  
- Month impact: The month impacts ride duration, with July showing longer rides compared to January for both bike types and user categories.