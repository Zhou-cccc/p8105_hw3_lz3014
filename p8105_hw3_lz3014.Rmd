---
title: "p8105_hw3_lz3014"
auther: "Liqi Zhou"
date: 2024-10-14
output: github_document
---

```{r}
library(tidyverse)
```


# Problem 1
```{r}
library(p8105.datasets)
data("ny_noaa")
```

### 1.Write a short description of the dataset.
This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns, including seven variables: `id` (weather station id), `date` (date of observation), `prcp` (total daily precipitation), `snow` (snowfall), `snwd` (snow depth), `tmax` and `tmin` (min and max temperature).

### 2.Do some data cleaning. 
```{r}
ny_noaa_clean <- ny_noaa |>
  separate(date, into = c("year", "month", "day"), convert = TRUE) |>
  mutate(tmax = as.numeric(tmax), tmin = as.numeric(tmin))
```

- For snowfall, what are the most commonly observed values? Why?
0 is the most commonly observed value for snowfall, because most days of the year, it does not snow in NY.
```{r}
ny_noaa_clean |>
  count(snow) |>
  arrange(desc(n))
```

### 3.Make a two-panel plot showing the average max temperature in January and in July in each station across years.
```{r}
ny_noaa_clean |>
  filter(month %in% c(1, 7)) |>
  group_by(id, year, month) |>
  summarise(mean_tmax = mean(tmax, na.rm = TRUE)) |>
  ggplot(aes(x = year, y = mean_tmax, color = as.factor(month))) +
  geom_point() +
  geom_line() +
  facet_wrap(~ month, scales = "free_y") +
  labs(
    title = "Average Max Temperature in January and July across Stations",
    x = "Year",
    y = "Average Max Temperature (°C)",
    color = "Month"
  )
```

- Is there any observable / interpretable structure? Any outliers?
the mean temperature in January is significantly lower than in July across all stations and years. Stations generally show similar temperature trends over time—when one station records a higher temperature for a given year, others tend to follow the same pattern. However, we observe an unusually cold station in July of 1987 or 1988, along with a few other minor outliers.

### 4.Make a two-panel plot
- (i) tmax vs tmin for the full dataset (note that a scatterplot may not be the best option)
```{r}
ny_noaa_clean |>
  ggplot(aes(x = tmin, y = tmax)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", color = "lightblue", se = FALSE) + 
  labs(
    title = "Tmax vs Tmin",
    x = "Minimum Temperature (°C)",
    y = "Maximum Temperature (°C)"
  )
```

- (ii) make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.
```{r}
ny_noaa_clean |>
  filter(snow > 0, snow < 100) |>
  ggplot(aes(x = snow)) +
  geom_histogram(binwidth = 5, fill = "lightblue", color = "lightyellow") +
  facet_wrap(~ year) +
  labs(
    title = "Distribution of Snowfall by Year",
    x = "Snowfall",
    y = "Count"
  )
```


# Problem 2
### 1.Load, tidy, merge, and otherwise organize the data sets.
```{r}
covar <- read_csv(file = "./data/nhanes_covar.csv", skip = 4, na = c("NA",".","")) |>
  janitor::clean_names() |>
  filter(age >= 21) |>
  drop_na()

accel <- read_csv(file = "./data/nhanes_accel.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  drop_na()
```

- merge and tidy
```{r}
mims <- covar |>
  left_join(accel, by = "seqn")

mims_tidy <- 
  pivot_longer(
    mims,
    min1:min1440,
    names_to = "mins",
    names_prefix = "min",
    values_to = "accel_min_data"
  ) |>
  mutate(mins = as.numeric(mins))
```

- encode data with reasonable variable classes
```{r}
mims_tidy <- mims_tidy |>
  mutate(sex = factor(sex, levels = c(1, 2), 
                      labels = c("Male", "Female")), 
         education = factor(education, levels = c(1, 2, 3), 
                            labels = c("Less than high school", "High school equivalent", "More than high school")))
mims_tidy
```

### 2.Produce a reader-friendly table for the number of men and women in each education category 
```{r}
sex_tb <- mims_tidy |>
  group_by(education, sex) |>
  summarise(n_obs = n()) |>
  knitr::kable()
sex_tb
```

- create a visualization of the age distributions for men and women in each education category.
```{r}
mims_tidy |>
  ggplot(aes(x = age, fill = sex, color = sex)) + 
  geom_density(alpha = 0.5) +  
  facet_grid(. ~ education) +  
  labs(
    title = "Age Distribution by Gender and Education Level",
    x = "Age",
    y = "Density"
  ) +
  theme_minimal()
```

 **comment:**  
- The `table` shows that the *"Less than high school"* level has the largest number of participants, and the distribution between men and women is relatively balanced in *"Less than high school"* and *"More than high school"*education levels. However, in the "High school equivalent" group, the number of men is much higher than the number of women.  
- The density `plot` shows that older individuals are more concentrated in the "Less than high school" group, while younger and middle-aged individuals are more evenly distributed in the "More than high school" group. There are also some gender differences in age distribution, particularly in the "More than high school" category.

### 3.Traditional analyses of accelerometer data 
- create a total activity variable for each participant. 
```{r}
mims_tidy <- mims_tidy |>
  group_by(seqn, sex, age, education) |>
  mutate(total_activity = sum(accel_min_data, na.rm = TRUE)) |>
  ungroup()
```

- Plot these total activities (y-axis) against age (x-axis). Include a trend line or a smooth to illustrate differences. 
```{r}
# calculate total activity for each person
mims_total_activity <- mims_tidy |>
  group_by(seqn, sex, age, education) |>
  summarise(total_activity = sum(accel_min_data, na.rm = TRUE)) |>
  ungroup()

mims_total_activity |>
  ggplot(aes(x = age, y = total_activity, color = sex)) + 
  geom_point(alpha = 0.5) +  
  geom_smooth(method = "loess", se = FALSE) +  
  facet_wrap(~ education) + 
  labs(
    title = "Total Activity by Age, Sex and Education Level",
    x = "Age",
    y = "Total Activity",
    color = "Sex"
  ) +
  theme_minimal()
```

**Comment:**  
- The plot shows that total activity generally decreases with age, especially for those with *"Less than a high school"* education level. In the *"High school equivalent"*, women's activity show more pronounced fluctuations. In the *"More than high school"* group, both sexes show similar trends.In the latter two groups, women are more numerous and maintain slightly higher activity while in *"Less than a high school"* men are more numerous than women across most age.


